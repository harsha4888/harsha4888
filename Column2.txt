

Quarter1 = 
IF(
    [date_filtered] = 0, 
    YEAR('Viz Expenses'[Created Date]) * 10 + QUARTER('Viz Expenses'[Created Date]),
    IF(
        [date_filtered] = 1, 
        YEAR('Viz Expenses'[Payment Date]) * 10 + QUARTER('Viz Expenses'[Payment Date]),
        YEAR('Viz Expenses'[Transaction Date]) * 10 + QUARTER('Viz Expenses'[Transaction Date])
    )
)

Quarter1 Rank = 
RANKX(
    ALL('Viz Expenses'),  -- Rank across all records
    'Viz Expenses'[Quarter1],  -- Rank based on the Quarter1 column
    ,  -- No specific value for tie-breaking
    ASC,  -- Rank in ascending order (older quarters first)
    DENSE  -- Use DENSE ranking (no gaps in ranking if there are ties)
)

Current or Last Quarter = 
VAR CurrentYear = YEAR(TODAY())
VAR CurrentQuarter = QUARTER(TODAY())
VAR MaxQuarter = CurrentYear * 10 + CurrentQuarter  -- Current quarter in YYYYQ format
VAR LastQuarter = IF(CurrentQuarter = 1, (CurrentYear - 1) * 10 + 4, CurrentYear * 10 + CurrentQuarter - 1)  -- Last quarter in YYYYQ format
VAR QuartEncoded = 'Viz Expenses'[Quarter1]  -- Using Quarter1 directly

RETURN
    IF(
        QuartEncoded = MaxQuarter, 
        "Current Quarter",
        IF(
            QuartEncoded = LastQuarter, 
            "Last Quarter", 
            BLANK()
        )
    )


Current or Last Quarter Rank = 
SWITCH(
    TRUE(),
    'Viz Expenses'[Current or Last Quarter] = "Current Quarter", 1,
    'Viz Expenses'[Current or Last Quarter] = "Last Quarter", 2,
    BLANK()
)

